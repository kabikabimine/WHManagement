$(document).ready(function() {
  // Lấy URL hiện tại
  var currentPath = window.location.pathname;

  // Xóa class active ở tất cả các mục
  $('.nav-link').removeClass('active');

  // Kiểm tra đường dẫn và thêm class active vào mục tương ứng
  $('.nav-link').each(function() {
    var linkPath = $(this).attr('href');
    
    // Nếu linkPath trùng với URL hiện tại, chỉ thêm class active vào mục đó
    if (currentPath === linkPath) {
      $(this).addClass('active');
    }
  });

  // Sự kiện click cho các mục nav
  $('.nav-link').on('click', function() {
    // Xóa class active từ tất cả các mục
    $('.nav-link').removeClass('active');
    
    // Thêm class active cho mục vừa được nhấn
    $(this).addClass('active');
  });

  $('#form1').on('submit', function(event) {
    event.preventDefault(); // Ngăn không cho form gửi mặc định

    $.ajax({
      url: '/import',
      type: 'POST',
      data: $(this).serialize(), // Serialize dữ liệu form
      success: function(response) {
        alert('Data imported successfully');
        console.log(response);
        // Reset form fields
        $('#form1')[0].reset();
      },
      error: function(error) {
        alert('Error importing data');
        console.error(error);
      }
    });
  });
});

// Thực hiện khi tài liệu HTML đã được tải
document.addEventListener('DOMContentLoaded', function() {
  var switches = [
    { switchId: 'switch1', formId: 'form1', storageKey: 'switchState1' },
    { switchId: 'switch2', formId: 'form2', storageKey: 'switchState2', useCamera: true },
    { switchId: 'switch3', formId: 'form3', storageKey: 'switchState3' }
  ];

  var video = document.getElementById('video-preview');
  var currentStream = null; // Biến toàn cục để lưu stream camera

  // Hàm khởi động camera
  function startCamera() {
    if (!video) return;
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => {
        currentStream = stream; // Lưu stream vào biến toàn cục
        video.srcObject = stream;
        video.setAttribute('playsinline', true); // Đảm bảo video chạy trong trang
        video.play();
        console.log('Camera started');
      })
      .catch(error => {
        console.error('Error accessing camera:', error);
      });
  }

  // Hàm dừng camera
  function stopCamera() {
    if (currentStream) {
      console.log('Stopping camera...');
      currentStream.getTracks().forEach(track => track.stop()); // Dừng tất cả các track trong stream
      video.srcObject = null; // Xóa nguồn video
      currentStream = null; // Đặt lại biến stream
    } else {
      console.log('No camera stream to stop.');
    }
  }

  // Duyệt qua từng switch để xử lý sự kiện và khôi phục trạng thái
  switches.forEach(function(item) {
    var switchElement = document.getElementById(item.switchId);
    var formElement = document.getElementById(item.formId);

    // Kiểm tra trạng thái trong localStorage
    var switchState = localStorage.getItem(item.storageKey);
    if (switchState === 'on') {
      switchElement.checked = true;
      formElement.style.display = 'block';
      if (item.useCamera) {
        startCamera(); // Bật camera khi switch2 được bật
      }
    } else {
      switchElement.checked = false;
      formElement.style.display = 'none';
      if (item.useCamera) {
        stopCamera(); // Tắt camera khi switch2 bị tắt
      }
    }

    // Xử lý sự kiện thay đổi trạng thái của switch
    switchElement.addEventListener('change', function() {
      if (this.checked) {
        formElement.style.display = 'block';
        localStorage.setItem(item.storageKey, 'on'); // Lưu trạng thái "on" cho switch này
        if (item.useCamera) {
          startCamera(); // Bật camera khi switch2 được bật
        }
      } else {
        formElement.style.display = 'none';
        localStorage.setItem(item.storageKey, 'off'); // Lưu trạng thái "off"
        if (item.useCamera) {
          stopCamera(); // Tắt camera khi switch2 bị tắt
        }
      }
    });
  });

  function scanQRCode() {
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    const resultElement = document.getElementById('result');

    function tick() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.height = video.videoHeight;
        canvas.width = video.videoWidth;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        try {
          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);

          if (code) {
            resultElement.textContent = 'QR Code Data: ' + code.data;
            console.log('QR Code Data:', code.data);
          } else {
            resultElement.textContent = 'No QR code detected.';
          }
        } catch (error) {
          console.error('Error reading image data:', error);
          resultElement.textContent = 'Error reading QR code.';
        }
      }
      requestAnimationFrame(tick);
    }

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
          video.srcObject = stream;
          video.setAttribute('playsinline', true); // For iOS devices
          video.play();
          tick();
        })
        .catch(err => {
          console.error("Error accessing camera: ", err);
          resultElement.textContent = 'Unable to access camera.';
        });
    } else {
      resultElement.textContent = 'Camera not supported.';
    }
  }

  function startBarcodeScanner() {
    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: document.querySelector('#video-preview'), // Element video
        constraints: {
          facingMode: "environment"
        }
      },
      decoder: {
        readers: ["code_128_reader", "ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader"]
      }
    }, function(err) {
      if (err) {
        console.error('Quagga init error:', err);
        return;
      }
      Quagga.start();
    });

    Quagga.onDetected(function(result) {
      console.log('Barcode Data:', result.codeResult.code);
      document.getElementById('result').textContent = 'Barcode Data: ' + result.codeResult.code;
    });

    Quagga.onProcessed(function(result) {
      if (result) {
        var drawingCtx = Quagga.canvas.dom.image.getContext('2d');
        if (result.boxes) {
          drawingCtx.clearRect(0, 0, drawingCtx.canvas.width, drawingCtx.canvas.height);
          result.boxes.forEach(function(box) {
            drawingCtx.strokeStyle = "#00F";
            drawingCtx.strokeRect(box.x, box.y, box.width, box.height);
          });
        }
      }
    });
  }

  // Bắt đầu hoặc dừng quét mã vạch và mã QR khi công tắc switch2 thay đổi
  var switch2 = document.getElementById('switch2');
  if (switch2) {
    if (switch2.checked) {
      startCamera(); // Khởi động camera khi trang được tải
      startBarcodeScanner(); // Bắt đầu quét mã vạch nếu switch2 đang bật
      scanQRCode(); // Bắt đầu quét mã QR nếu switch2 đang bật
    }

    switch2.addEventListener('change', function() {
      if (this.checked) {
        document.getElementById('form2').style.display = 'block';
        startCamera(); // Bắt đầu camera khi switch2 được bật
        startBarcodeScanner(); // Bắt đầu quét mã vạch khi switch2 được bật
        scanQRCode(); // Bắt đầu quét mã QR khi switch2 được bật
      } else {
        document.getElementById('form2').style.display = 'none';
        stopCamera(); // Dừng camera khi switch2 bị tắt
        Quagga.stop(); // Dừng quét mã vạch khi switch2 bị tắt
      }
    });
  } else {
    console.error('Switch2 element does not exist.');
  }
});
